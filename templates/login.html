{% extends 'base.html' %}

{% block contenido %}
<div class="row justify-content-center align-items-center" style="min-height: calc(100vh - 200px);">
    <div class="col-12 col-md-10 col-lg-8 col-xl-6">
        <div class="card-custom p-5 animate__animated animate__fadeIn">
            <div class="text-center mb-4">
                <div class="mb-3">
                    <i class="fas fa-gamepad" style="font-size: 4rem; color: var(--accent-primary);"></i>
                </div>
                <h1 class="display-5 fw-bold mb-2">
                    <span style="background: linear-gradient(135deg, var(--accent-primary) 0%, var(--accent-secondary) 100%); 
                                 -webkit-background-clip: text; -webkit-text-fill-color: transparent;">
                        Bienvenido a SquadFinder
                    </span>
                </h1>
                <p class="text-secondary mb-0">Encuentra tu squad perfecto para jugar</p>
            </div>

            <form onsubmit="event.preventDefault(); iniciarSesion();">
                <div class="mb-4">
                    <label class="form-label-custom">
                        <i class="fas fa-user me-2"></i>Usuario
                    </label>
                    <input
                        type="text"
                        id="usuario"
                        class="form-control form-control-custom"
                        placeholder="Tu nombre de usuario"
                        required
                        autocomplete="username"
                    >
                </div>

                <div class="mb-4">
                    <label class="form-label-custom">
                        <i class="fas fa-lock me-2"></i>Contrase침a
                    </label>
                    <div class="position-relative">
                        <input
                            type="password"
                            id="clave"
                            class="form-control form-control-custom"
                            placeholder="Tu contrase침a"
                            required
                            autocomplete="current-password"
                        >
                        <button
                            type="button"
                            class="btn btn-link position-absolute end-0 top-50 translate-middle-y text-secondary"
                            onclick="togglePassword()"
                            style="z-index: 10;"
                        >
                            <i class="fas fa-eye" id="toggleIcon"></i>
                        </button>
                    </div>
                </div>

                <button type="submit" class="btn btn-custom-primary w-100 py-3 mb-3">
                    <i class="fas fa-sign-in-alt me-2"></i>INICIAR SESI칍N
                </button>
            </form>

            <div id="error" class="alert alert-danger d-none mb-3" role="alert">
                <i class="fas fa-exclamation-circle me-2"></i>
                <span id="errorText"></span>
            </div>

            <div class="position-relative my-4">
                <hr style="border-color: var(--border-color);">
                <span class="position-absolute top-50 start-50 translate-middle px-3"
                      style="background: rgba(26, 31, 58, 0.8); color: var(--text-secondary);">
                    쯅uevo en SquadFinder?
                </span>
            </div>

            <div class="text-center">
                <p class="text-secondary mb-3">칔nete a nuestra comunidad de gamers</p>
                <a href="/registro/" class="btn btn-custom-success w-100 py-3">
                    <i class="fas fa-user-plus me-2"></i>CREAR CUENTA GRATIS
                </a>
            </div>
        </div>
    </div>
</div>

<script>
function togglePassword() {
    const input = document.getElementById('clave');
    const icon = document.getElementById('toggleIcon');

    if (input.type === 'password') {
        input.type = 'text';
        icon.classList.replace('fa-eye', 'fa-eye-slash');
    } else {
        input.type = 'password';
        icon.classList.replace('fa-eye-slash', 'fa-eye');
    }
}

async function iniciarSesion() {
    const usuario = document.getElementById('usuario').value.trim();
    const clave = document.getElementById('clave').value;
    const errorDiv = document.getElementById('error');
    const errorText = document.getElementById('errorText');

    errorDiv.classList.add('d-none');

    if (!usuario || !clave) {
        mostrarError('Por favor completa todos los campos');
        return;
    }

    const btn = document.querySelector('button[type="submit"]');
    const original = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Iniciando sesi칩n...';

    try {
        const res = await fetch('/api/auth/login/', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username: usuario, password: clave })
        });

        const datos = await res.json();

        if (res.ok) {
            // 游댐 CLAVE: datos consistentes para la navbar
            localStorage.setItem('access_token', datos.access);
            localStorage.setItem(
                'usuario_actual',
                datos.user?.gamertag || datos.user?.username || usuario
            );

            window.location.href = '/dashboard/';
        } else {
            mostrarError('Usuario o contrase침a incorrectos');
            btn.disabled = false;
            btn.innerHTML = original;
        }
    } catch (e) {
        mostrarError('Error de conexi칩n. Intenta nuevamente.');
        btn.disabled = false;
        btn.innerHTML = original;
    }
}

function mostrarError(msg) {
    const div = document.getElementById('error');
    document.getElementById('errorText').textContent = msg;
    div.classList.remove('d-none');
}
</script>
{% endblock %}
